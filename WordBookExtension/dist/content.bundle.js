(()=>{const e=["floatingButton","div_save","word_floating"];let t={},n={},o={};async function a(e){if(e.nodeType===Node.TEXT_NODE){let o=0,a=[],l=[],s=[];for(;;){let n=Object.values(t).map((t=>e.textContent.indexOf(t.name,o)));if(n.every((e=>e<0)))break;let i=Array.from(n.keys());i.sort(((e,t)=>n[e]<0?1:n[t]<0?-1:n[e]-n[t]));let c=Object.values(t)[i[0]],d=i[0];s.push(d),a.push(n[d]),l.push(n[d]+c.name.length),o=n[d]+c.name.length}let i=e.parentNode;if(0!=s.length){let o=Object.values(t).map((e=>Object.assign(document.createElement("span"),{className:"highlight",textContent:e.name,style:`text-decoration-color: ${n[`${e.id_category}.color`]}`,onmouseenter:t=>{let n=document.getElementById("word_floating");n&&n.remove();let o=Object.assign(document.createElement("div"),{className:"t div_word",textContent:"",id:"word_floating",style:`position: absolute; top: ${t.pageY}px; left: ${t.pageX}px; z-index: 1000;`}),a=(Object.assign(document.createElement("div"),{className:"t div_wordName",textContent:e.name}),Object.assign(document.createElement("div"),{className:"t div_wordData",textContent:e.desc}));o.appendChild(a);let l=Object.assign(document.createElement("button"),{className:"t div_debugInfo",textContent:"debug info...",isClosed:!0});l.addEventListener("click",(function(){let t=l.isClosed;l.textContent=t?JSON.stringify(e):"debug info...",l.isClosed=!t})),o.appendChild(l),document.body.appendChild(o)}})));s.forEach(((t,n)=>{let s=e.textContent.slice(n<=0?0:l[n-1],a[n]),c=e.textContent.slice(l[n],n>=e.textContent.length-1?e.textContent.length-1:a[n+1]);i.insertBefore(document.createTextNode(s),e),i.insertBefore(o[t],e),i.insertBefore(document.createTextNode(c),e)})),i.removeChild(e)}}else for(let t=0;t<e.childNodes.length;t++)"highlight"!==e.childNodes[t].className&&a(e.childNodes[t])}function l(){return new Promise((e=>{chrome.storage.local.get({wordList:{},categoryList:{},userProfile:{}},(function(a){t=a.wordList,n=a.categoryList,0===n.length&&n.constructor,o=a.userProfile,console.log(`loaded: \nwordList: ${JSON.stringify(t)}\ncategoryList: ${JSON.stringify(n)}\nuserProfile: ${JSON.stringify(o)}.`),e("loaded")}))}))}function s(){return new Promise((e=>{chrome.storage.local.set({wordList:t,categoryList:n,userProfile:o},(function(a){console.log(`saved: \nwordList: ${JSON.stringify(t)}\ncategoryList: ${JSON.stringify(n)}\nuserProfile: ${JSON.stringify(o)}.`),e("saved")}))}))}function i(e){let t="";for(let n=0;n<e;n++)t+="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789".charAt(Math.floor(62*Math.random()));return t}document.addEventListener("click",(async function(a){let l=window.getSelection(),c=l.toString().trim();if(e.forEach((e=>{let t=document.getElementById(e);!t||t.contains(a.target)||t.remove()})),c.length>0){console.log(`select: ${c}`);let e=Object.assign(document.createElement("button"),{id:"floatingButton",textContent:"save",style:`position: absolute; top: ${a.pageY}px; left: ${a.pageX}px; z-index: 1000;`});e.addEventListener("mousedown",(function(){console.log("add new word");let d=Object.assign(document.createElement("div"),{id:"div_save",className:"t div_word",textContent:null,style:`position: absolute; top: ${a.pageY}px; left: ${a.pageX}px; z-index: 1000; width: 16rem; overflow: auto;`}),r=Object.assign(document.createElement("div"),{className:"t div_wordName",textContent:c,style:""});d.appendChild(r);let m=Object.assign(document.createElement("div"),{className:"t div_wordData",style:""});d.appendChild(m),async function(){m.textContent="Generating response...";let e=function(e,t){if(0===e.rangeCount)return null;const n=e.getRangeAt(0),o=n.startContainer;if(o!==n.endContainer||o.nodeType!==Node.TEXT_NODE)return null;const a=n.startOffset,l=n.endOffset,s=o.textContent,i=Math.max(0,a-20),c=Math.min(s.length,l+20);return s.slice(i,c)}(l),t=`単語:${c} 文章:...${e}...`;try{m.textContent=await async function(e){let t="";console.log(`prompt: ${e}`);try{const n=await fetch("https://api.openai.com/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${o.apiKey}`},body:JSON.stringify({model:"gpt-3.5-turbo",messages:[{role:"system",content:"文章における単語の解説をしてください。解説は日本語で一文にして簡潔に述べてください。"},{role:"user",content:e}]})}),a=await n.json();t=a.choices?a.choices[0].message.content:JSON.stringify(a),console.log(`reply: ${t}`)}catch(e){console.error(`Error: ${e}`),t=e}return t}(t)}catch(e){m.textContent="Error generating response",console.error("Error:",e)}}();let g=Object.assign(document.createElement("div"),{className:"",style:"display: flex; justify-content: flex-end;"}),u=Object.assign(document.createElement("select"),{className:"t",style:"flex: 1 1 auto; overflow-x: auto;"});const p=new CustomEvent("reload_sel_category",{detail:{message:"reload_sel_category"}});function y(){u.innerHTML="",Object.entries(n).forEach((([e,t])=>{let n=Object.assign(document.createElement("option"),{value:e,textContent:t.name});"new"!=n.value&&u.appendChild(n)}));let e=Object.assign(document.createElement("option"),{className:"t",textContent:"new category",value:"new"});u.appendChild(e),document.dispatchEvent(p)}g.appendChild(u);let f=Object.assign(document.createElement("button"),{className:"t",textContent:"add",style:"flex: 0 0 auto;"});f.addEventListener("reload_sel_category",(()=>{u.value?f.textContent="add":f.textContent="create"})),y();let h=Object.assign(document.createElement("div"),{className:"",style:"display: flex; flex-direction: column;"});h.style.display="none",div_col_01=Object.assign(document.createElement("div"),{style:"display: flex; align-items: center; width: 100%;"});let v=Object.assign(document.createElement("input"),{className:"t",type:"text",placeholder:"category name",style:"flex: 1 1 auto; overflow-x: scroll"});div_col_01.appendChild(v);let x=Object.assign(document.createElement("div"),{className:"t",style:"flex: 0 0 auto; width: 2rem; height: 2rem; opacity: 1; z-index: 0; padding: 0rem;"});div_col_01.appendChild(x);let C=Object.assign(document.createElement("input"),{className:"t",type:"color",style:"width: 100%; height: 100%; opacity: 0; z-index: 1; margin: 0rem; padding: 0rem"});C.addEventListener("change",(function(){x.style.backgroundColor=C.value})),x.appendChild(C),h.appendChild(div_col_01),x.style.backgroundColor=C.value;let w=Object.assign(document.createElement("div"),{className:"",textContent:"",style:"color: red;text-align: center;display: flex;width: 100%; justify-content: center; font-size: 80%"});h.appendChild(w);let b=Object.assign(document.createElement("div"),{style:"display: flex; align-items: center; justify-content: flex-end; width: 100%;"}),E=Object.assign(document.createElement("button"),{className:"t",textContent:"cancel",style:""});E.addEventListener("click",(function(){y(),g.style.display="flex",h.style.display="none"})),b.appendChild(E);let O=Object.assign(document.createElement("button"),{className:"t",textContent:"create",style:""});O.addEventListener("click",(async function(){n.find((e=>e.name===v.value))?(w.textContent="this category already exists",w.style.display="flex"):""===v.value?(w.textContent="category name is empty",w.style.display="flex"):(w.style.display="none",n[`${i(8)}`]={name:v.value,color:C.value},y(),await s(),g.style.display="flex",h.style.display="none")})),b.appendChild(O),h.appendChild(b),d.appendChild(h),f.addEventListener("click",(async function e(){if("new"===u.value)console.log("create new category"),g.style.display="none",h.style.display="flex";else{console.log("add new word");let n=i(8);t[`${n}`]={name:c,desc:m.textContent,timestamp:(new Date).toISOString(),id_category:u.value},console.log(`wordList: ${JSON.stringify(t)}`),await s(),f.removeEventListener("click",e),f.textContent="saved",u.style.display="none"}})),u.addEventListener("change",(function(){u.value?f.textContent="add":f.textContent="create"})),g.appendChild(f),d.appendChild(g),document.body.appendChild(d),e.remove(),l.removeAllRanges?l.removeAllRanges():l.empty&&l.empty()})),document.body.appendChild(e)}})),window.onload=async function(){console.log("window.onload");try{await l(),a(document.body)}catch(e){console.error(e)}},chrome.runtime.onMessage.addListener(((e,t,n)=>async function(){if(console.log(`message: ${e.message}`),"localStorageUpdated"===e.message)try{await l(),a(document.body)}catch(e){console.error(e)}}))})();